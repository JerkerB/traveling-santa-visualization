<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Traveling santa visualization</title>
    <style>
      body {
        font-family: 'Courier New', Courier, monospace;
        margin: 0;
      }
      canvas {
        width: 100%;
        height: 100%;
      }
      .header {
        text-align: center;
        padding: 20px;
        background-color: #532c54;
        color: white;
      }
      .flex-container {
        height: 100%;
        background-color: #d9d0dd;
        display: flex;
        flex-wrap: wrap;
      }
      .controls {
        text-align: center;
        flex: 1;
        color: #89538a;
      }
      #visualization {
        flex: 3;
      }
      #drop-box {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10px;
        height: 50%;
        border-width: 5px;
        border-style: dashed;
      }
      #run-btn {
        background-color: #89538a;
        color: #d9d0dd;
        border: none;
        outline: none;
        cursor: pointer;
        height: 45px;
        padding: 15px 30px;
        font-weight: bold;
        letter-spacing: 1px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="header"><h1>Traveling santa challenge visualization</h1></div>
    <div class="flex-container">
      <div class="controls">
        <h2>Controls</h2>
        <div id="drop-box"><h3>Drag your file here</h3></div>
        <div class="control-inputs"></div>
        <button id="run-btn">Run</button>
      </div>
      <div id="visualization"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/99/three.min.js"></script>
    <script>
      var dropBoxEl = document.getElementById('drop-box');
      dropBoxEl.addEventListener('drop', dropHandler);
      dropBoxEl.addEventListener('dragover', dragOverHandler);
      var runBtnEl = document.getElementById('run-btn');
      runBtnEl.addEventListener('click', runVisualization);
      var gifts = [];

      function dragOverHandler(e) {
        e.stopPropagation();
        e.preventDefault();
      }

      function dropHandler(e) {
        e.stopPropagation();
        e.preventDefault();
        const file = getFileFromEvent(e);
        gitfts = loadGiftsFromFile(file);
        removeDragData(e);
      }

      function getFileFromEvent(e) {
        if (e.dataTransfer.items) {
          return e.dataTransfer.items[0].getAsFile();
        }
        return e.dataTransfer.files[0];
      }

      function removeDragData(e) {
        if (e.dataTransfer.items) {
          e.dataTransfer.items.clear();
        } else {
          e.dataTransfer.clearData();
        }
      }
      function loadGiftsFromFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          var text = e.target.result.trim();
          gifts = text.replace(/\r?\n|\r/g, '').split(';');
        };
        reader.readAsText(file);
      }

      function runVisualization() {
        gifts.forEach((gift, index) => {
          setTimeout(() => {
            deliverGift(parseInt(gift));
          }, 1000 * index);
        });
      }
    </script>
    <script>
      var EARTH_RADIUS = 67.38;
      var visualizationEl = document.getElementById('visualization');
      var visualizationWidth = visualizationEl.getBoundingClientRect().width;
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(45, visualizationWidth / window.innerHeight, 0.1, 1000);
      var renderer = new THREE.WebGLRenderer();
      camera.up.set(0, 0, 1);
      var axesHelper = new THREE.AxesHelper(100);
      scene.add(axesHelper);
      renderer.setSize(visualizationWidth, window.innerHeight);
      document.getElementById('visualization').appendChild(renderer.domElement);

      var group = new THREE.Group();
      var earthMesh = createEarthMesh();
      var korvatunturiMesh = createKorvatunturiMesh();
      group.add(earthMesh, korvatunturiMesh);
      getGifstFromNiceList().then(gifts => {
        mesh = createGiftMesh(gifts);
        group.add(mesh);
      });
      scene.add(group);

      camera.position.z = 300;
      render();

      var rotation = 0.1;

      function render() {
        requestAnimationFrame(render);
        group.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), 0.01);
        renderer.render(scene, camera);
      }

      function deliverGift(giftId) {
        var attributes = group.getObjectByName('gifts').geometry.attributes;
        var giftIndex = findGiftIndex(attributes.id.array, giftId);

        var colorAttribute = attributes.color;
        setColorForGift(colorAttribute.array, giftIndex, new THREE.Color(0xffffff));
        colorAttribute.needsUpdate = true;
      }

      function findGiftIndex(idArray, giftId) {
        return idArray.findIndex(id => {
          return id === giftId;
        });
      }

      function LLAtoECEF(radius, latitude, longitude, alt) {
        var flattening = 0;
        var latitudeAtMeanSeaLevel = Math.atan(Math.pow(1 - flattening, 2) * Math.tan(latitude));
        var x = radius * Math.cos(latitudeAtMeanSeaLevel) * Math.cos(longitude) + alt * Math.cos(latitude) * Math.cos(longitude);
        var y = radius * Math.cos(latitudeAtMeanSeaLevel) * Math.sin(longitude) + alt * Math.cos(latitude) * Math.sin(longitude);
        var z = radius * Math.sin(latitudeAtMeanSeaLevel) + alt * Math.sin(latitude);
        return new THREE.Vector3(-x, -z, -y);
      }

      function createEarthMesh() {
        var segments = 30;
        var rings = 30;
        var geometry = new THREE.SphereGeometry(EARTH_RADIUS, segments, rings);
        var material = new THREE.MeshBasicMaterial({ color: 'black' });
        var earthMesh = new THREE.Mesh(geometry, material);

        return new THREE.Mesh(geometry, material);
      }

      function createKorvatunturiMesh() {
        return createPointMeshFromCoordinate(30, 0x0000ff, 68.073611, 29.315278);
      }

      function createCubeMeshFromCoordinate(width, height, depth, color, latitude, longitude) {
        var geometry = new THREE.BoxGeometry(width, height, depth);
        var material = new THREE.MeshBasicMaterial({ color: color });
        var coordinateMesh = new THREE.Mesh(geometry, material);
        var pos = LLAtoECEF(EARTH_RADIUS, latitude, longitude, 0);
        coordinateMesh.position.set(pos.x, pos.y, pos.z);
        return coordinateMesh;
      }

      function createPointMeshFromCoordinate(size, color, latitude, longitude) {
        var geometry = new THREE.Geometry();
        geometry.vertices.push(new THREE.Vector3());
        var material = new THREE.PointsMaterial({ size: size, sizeAttenuation: false, color: color });
        var coordinateMesh = new THREE.Points(geometry, material);
        var pos = LLAtoECEF(EARTH_RADIUS, latitude, longitude, 0);
        coordinateMesh.position.set(pos.x, pos.y, pos.z);
        return coordinateMesh;
      }

      function readFile(pathToFile) {
        return fetch(pathToFile)
          .then(response => response.text())
          .then(text => {
            return text;
          });
      }

      async function getGifstFromNiceList() {
        var text = await readFile('nicelist.txt');
        var gifts = text.split('\n').map(x => {
          var props = x.split(';');
          return { id: props[0], lat: props[1], lon: props[2], weight: props[3] };
        });
        return gifts;
      }

      function createGiftMesh(gifts) {
        var geometry = new THREE.BufferGeometry();
        var vertices = new Float32Array(gifts.length * 3);
        var colors = new Float32Array(gifts.length * 3);
        var ids = new Float32Array(gifts.length);
        var color = new THREE.Color(0xff0000);
        gifts.forEach((gift, giftIndex) => {
          ids[giftIndex] = gift.id;
          var pos = LLAtoECEF(EARTH_RADIUS, gift.lat, gift.lon, 0);
          setPositionForGift(vertices, giftIndex, pos);
          setColorForGift(colors, giftIndex, color);
        });
        geometry.addAttribute('id', new THREE.BufferAttribute(ids, 1));
        geometry.addAttribute('position', new THREE.BufferAttribute(vertices, 3));
        geometry.addAttribute('color', new THREE.BufferAttribute(colors, 3));
        var material = new THREE.PointsMaterial({ size: 2, vertexColors: THREE.VertexColors });
        var mesh = new THREE.Points(geometry, material);
        mesh.name = 'gifts';
        return mesh;
      }

      function setColorForGift(colors, giftIndex, color) {
        var attrIndex = giftIndex * 3;
        colors[attrIndex] = color.r;
        colors[attrIndex + 1] = color.g;
        colors[attrIndex + 2] = color.b;
      }

      function setPositionForGift(vertices, giftIndex, pos) {
        var attrIndex = giftIndex * 3;
        vertices[attrIndex] = pos.x;
        vertices[attrIndex + 1] = pos.y;
        vertices[attrIndex + 2] = pos.z;
      }
    </script>
  </body>
</html>
